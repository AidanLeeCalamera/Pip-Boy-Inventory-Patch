(function(){const LIST_START_Y=10,LIST_LINE_HEIGHT=22,STATS_BOX_X=220,STATS_BOX_BOTTOM_Y=205;const STATS_BOX_WIDTH=170,STATS_PADDING=8,STAT_LINE_HEIGHT=20,TEXT_COLOR=3,BRIGHT_BG_COLOR=1,DITHER_COLOR=1;const ICONS={attack:atob("Hh6BAAADAAAADAAAADAAAADAAAADAAAAf4AAB/+AADjHAAGDBgAMAAwAMAAwAYAAYAYAAYAYAAYP+AB//+AB/wYAAYAYAAYAYAAYAMAAwAMAAwAGDBgADjHAAB/+AAAf4AAADAAAADAAAADAAAADAAAADAAA"),bleed:atob("BwyBAAAgQcPLl8/f/fHA"),energy:atob("BwyBADzx44ffvwwwYIAA"),fire:atob("CgyBAAgCAZB8X7/vu8fhsGYYAA=="),frost:atob("Dw+BAAEAAgAVABwAEASpBOR//xOQSpAEABwAVAAgAEAA"),rad:atob("EA+BABAIOBx8Pnw+/n7+f/2/AYAAAAGAA8AH4AfgD/ADwA=="),ammo:atob("EhOBAAAAB/53/5//53/5x/5wAAB/53/5//53/5x/5wAAB/53/5//53/5x/5wAAA="),time:atob("FRWBAAA8AAP4AAngAMOABg4CMDkMgNgwBsDgHgfA8B4HgPA8AwGgABmAAM4ADjAA4OAOA8HgD/4AD4AA"),shield:atob("DxKBAP/9h/oH9A/oH9A/oH9h/v/9/gv8F/gv8E/hn8YPmA/gBwA=")};var inventory=[],fileList=[],pageCounts=[],totalItems=0,currentPageIndex=-1;var selectedItemGlobalIndex=0,lastSelectedItemGlobalIndex=-1;var equippedGear={weapon:null,hat:null,eyewear:null,mask:null,clothing:null,chest:null,leftArm:null,rightArm:null,leftLeg:null,rightLeg:null,accessory:null};var currentItemImage=null,isItemSoundPlaying=false;function drawDitheredRect(e,t,a,n){bC.setColor(DITHER_COLOR);for(var r=t;r<t+n;r+=2){bC.fillRect(e,r,e+a,r)}}function loadMetadata(){try{var e=JSON.parse(fs.readFileSync("DATA/items_meta.json"));pageCounts=e.pageCounts;totalItems=0;for(var t=0;t<pageCounts.length;t++){totalItems+=pageCounts[t]}fileList=[];for(var a=0;a<pageCounts.length;a++){fileList.push("items_"+a+".json")}}catch(e){totalItems=0}}function loadPage(e){if(e<0||e>=fileList.length||currentPageIndex===e)return false;try{inventory=JSON.parse(fs.readFileSync("DATA/"+fileList[e]));currentPageIndex=e;return true}catch(e){inventory=[];return false}}function getPageAndLocalIndex(e){if(totalItems===0)return{page:0,local:0};e=(e%totalItems+totalItems)%totalItems;var t=0;for(var a=0;a<pageCounts.length;a++){if(e<t+pageCounts[a])return{page:a,local:e-t};t+=pageCounts[a]}return{page:0,local:0}}function loadItemImage(item){currentItemImage=null;if(item&&item.image){try{var fileContent=fs.readFileSync("DATA/"+item.image);var imageObject=eval("("+fileContent+")");imageObject.buffer=E.toArrayBuffer(imageObject.buffer);currentItemImage=imageObject}catch(e){}}}function drawStatGroup(e,t,a,n){if(!e||e.length===0)return a;var r=0;e.forEach(function(e){var a=ICONS[e.type];var n=bC.stringWidth(e.value);var A=0;if(a){var l=g.imageMetrics(a);var o=e.type==="attack"&&t==="Damage"?15:14;var i=o/l.height;A=l.width*i}r=Math.max(r,n+A+20)});var A=STATS_BOX_X+STATS_BOX_WIDTH-r;var l=e.length*STAT_LINE_HEIGHT;var o=n+STATS_PADDING+a;bC.setColor(BRIGHT_BG_COLOR);bC.fillRect(STATS_BOX_X+4,o-2,A-4,o+l-4);bC.setBgColor(BRIGHT_BG_COLOR);bC.setColor(TEXT_COLOR);bC.drawString(t,STATS_BOX_X+STATS_PADDING,o);e.forEach(function(e){var r=n+STATS_PADDING+a;var l=ICONS[e.type];bC.setColor(BRIGHT_BG_COLOR);bC.fillRect(A,r-2,STATS_BOX_X+STATS_BOX_WIDTH-4,r+STAT_LINE_HEIGHT-4);bC.setBgColor(BRIGHT_BG_COLOR);bC.setColor(TEXT_COLOR);if(l){var o=g.imageMetrics(l);var i=e.type==="attack"&&t==="Damage"?15:14;var s=i/o.height;var I=r+(STAT_LINE_HEIGHT-4-o.height*s)/2;bC.drawImage(l,A+2,I,{scale:s})}bC.setFontAlign(1,-1);bC.drawString(e.value,STATS_BOX_X+STATS_BOX_WIDTH-STATS_PADDING,r);bC.setFontAlign(-1,-1);a+=STAT_LINE_HEIGHT});return a}function renderItemStats(e){bC.setFontMonofonto16();if(!e)return;var t=(e.damages?e.damages.length:0)+(e.defenses?e.defenses.length:0)+(e.stats?Object.keys(e.stats).length:0);if(t===0)return;var a=t*STAT_LINE_HEIGHT+STATS_PADDING*2-2;var n=STATS_BOX_BOTTOM_Y-a;var r=0;r=drawStatGroup(e.damages,"Damage",r,n);r=drawStatGroup(e.defenses,"DMG Resist",r,n);if(e.stats){for(var A in e.stats){var l=n+STATS_PADDING+r;var o=e.stats[A];var i=typeof o==="object"&&o!==null;var s=i?o.value:o;var I=i&&o.isTimed;var T=A===e.ammoType;if(T){bC.setColor(BRIGHT_BG_COLOR);bC.fillRect(STATS_BOX_X+4,l,STATS_BOX_X+STATS_BOX_WIDTH-4,l+STAT_LINE_HEIGHT-4);bC.setBgColor(BRIGHT_BG_COLOR)}else{drawDitheredRect(STATS_BOX_X+4,l,STATS_BOX_WIDTH-8,STAT_LINE_HEIGHT-2);bC.setBgColor(0)}bC.setColor(TEXT_COLOR);var u=STATS_BOX_X+STATS_BOX_WIDTH-STATS_PADDING;if(T){var S=STATS_BOX_X+STATS_PADDING;if(ICONS.ammo){var d=g.imageMetrics(ICONS.ammo);var m=14/d.height;var _=l+(STAT_LINE_HEIGHT-4-d.height*m)/2;bC.drawImage(ICONS.ammo,S,_,{scale:m})}S+=16;bC.drawString(A,S,l)}else{bC.drawString(A,STATS_BOX_X+STATS_PADDING,l)}bC.setFontAlign(1,-1);bC.drawString(s,u,l);if(I){var d=g.imageMetrics(ICONS.time);var m=14/d.height;var _=l-1+(STAT_LINE_HEIGHT-4-d.height*m)/2;var f=u-bC.stringWidth(s)-d.width*m-7;bC.drawImage(ICONS.time,f,_,{scale:m})}bC.setFontAlign(-1,-1);r+=STAT_LINE_HEIGHT}}}function drawItem(e,t){const a=inventory[e];const n=LIST_START_Y+e*LIST_LINE_HEIGHT;const r=23;const A=STATS_BOX_X-15-r;bC.setBgColor(e===t?3:0);bC.setColor(e===t?0:3);bC.clearRect(10,n,STATS_BOX_X-10,n+LIST_LINE_HEIGHT-1);bC.setFontMonofonto16();if(Object.values(equippedGear).includes(a.name)){bC.fillRect(12,n+8,18,n+14)}const l=" ("+a.quantity+")";const o=bC.stringWidth(l);let i=a.name;const s=A-o;if(bC.stringWidth(i)>s){let e="";for(let t=0;t<i.length;t++){if(bC.stringWidth(e+i[t]+"...")>s){break}e+=i[t]}i=e+"..."}bC.drawString(i+l,r,n+3)}function renderFull(){if(totalItems===0){bC.clear(1).setFontMonofonto18().setColor(3).drawString("Inventory empty.",25,LIST_START_Y+3).flip();return}var e=getPageAndLocalIndex(selectedItemGlobalIndex);loadItemImage(inventory[e.local]);bC.clear(1);if(currentItemImage){bC.drawImage(currentItemImage,STATS_BOX_X+20,20)}for(var t=0;t<inventory.length;t++){drawItem(t,e.local)}renderItemStats(inventory[e.local]);bC.flip()}function onKnob(e){if(isItemSoundPlaying){if(Pip.audioIsPlaying()){return}else{isItemSoundPlaying=false}}var t=getPageAndLocalIndex(selectedItemGlobalIndex);var a=totalItems>0?inventory[t.local]:null;if(e===0){if(!a)return;if(a.type==="weapon"||a.type==="apparel"){isItemSoundPlaying=true;var n=Object.prototype.toString.call(a.equipSlots)==="[object Array]"?a.equipSlots:[a.equipSlots];if(n.length>0&&Array.isArray(n[0])){n=n[0]}var r=equippedGear[n[0]]===a.name;var A;var l;if(a.type==="weapon"){l=r?["EquipDown_01.wav","EquipDown_02.wav","EquipDown_03.wav"]:["EquipUp_02.wav","EquipUp_03.wav"]}else{l=r?["EquipDown_01.wav","EquipDown_02.wav","EquipDown_03.wav"]:["EquipUp_01.wav"]}A=l[Math.floor(Math.random()*l.length)];if(r){n.forEach(function(e){equippedGear[e]=null})}else{var o=[];n.forEach(function(e){var t=equippedGear[e];if(t&&o.indexOf(t)===-1){o.push(t)}});if(o.length>0){for(var i in equippedGear){if(o.indexOf(equippedGear[i])!==-1){equippedGear[i]=null}}}n.forEach(function(e){equippedGear[e]=a.name})}if(A)Pip.audioStart("DATA/"+A);renderFull()}else if(a.sounds&&a.sounds.length>0){isItemSoundPlaying=true;Pip.audioStart("DATA/"+a.sounds[Math.floor(Math.random()*a.sounds.length)])}return}if(totalItems<=1)return;Pip.knob1Click(e);lastSelectedItemGlobalIndex=selectedItemGlobalIndex;selectedItemGlobalIndex-=e;selectedItemGlobalIndex=(selectedItemGlobalIndex%totalItems+totalItems)%totalItems;if(selectedItemGlobalIndex===lastSelectedItemGlobalIndex)return;var s=getPageAndLocalIndex(lastSelectedItemGlobalIndex);var I=getPageAndLocalIndex(selectedItemGlobalIndex);var T=I.page!==s.page;if(T){loadPage(I.page);renderFull()}else{loadItemImage(inventory[I.local]);bC.setBgColor(0);bC.clearRect(STATS_BOX_X,0,bC.getWidth(),bC.getHeight());if(currentItemImage)bC.drawImage(currentItemImage,STATS_BOX_X+20,20);drawItem(s.local,I.local);drawItem(I.local,I.local);renderItemStats(inventory[I.local]);bC.flip()}}function start(){loadMetadata();if(totalItems>0){loadPage(0);selectedItemGlobalIndex=0}renderFull();Pip.on("knob1",onKnob);Pip.removeSubmenu=stop}function stop(){Pip.removeListener("knob1",onKnob);inventory=[];fileList=[];pageCounts=[];currentItemImage=null;currentPageIndex=-1;if(g.reset)g.reset()}if(MODEINFO[2]&&MODEINFO[2].submenu){var originalSubmenu=MODEINFO[2].submenu;var newSubmenu={};var inserted=false;for(var key in originalSubmenu){if(key==="ATTACHMENTS"){newSubmenu["ITEMS"]=start;inserted=true}newSubmenu[key]=originalSubmenu[key]}if(!inserted)newSubmenu["ITEMS"]=start;MODEINFO[2].submenu=newSubmenu}})();
